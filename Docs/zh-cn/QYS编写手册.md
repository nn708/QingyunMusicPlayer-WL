# **QYS编写手册**

QYS是青云播放器支持的一种文件格式，功能强大却又简单易学。
本文将介绍QYS文件的编写方法。

 - [音符与和弦][1]
 - [高级操作符][2]
 - [音轨与格式][3]
 - [变量与函数][4]

----------

## **快速上手**

如果你想要快速掌握QYS的主要语法，下面的内容可以帮助你在短时间内对这种语言形成一个快速的认识。

 - [唱名与调名][5]
 - [音高操作符][6]
 - [和弦记法][7]
 - [时值操作符][8]
 - [连音线][9]
 - [小节号与换行符][10]
 - [添加注释][11]
 - [基本变量声明][12]
 - [乐器的声明][13]

----------

## **音符与和弦**

首先我们介绍音符的记法。在这一点上，QYS基本沿用了简谱的记号，因此相信只要是熟悉简谱的人都能快速学会QYS的音符记法。

### **唱名与调名**

 - 与简谱类似，用数字`1~7`分别代表唱名。
 - 与简谱类似，用数字`0`表示休止符。
 - 与简谱类似，用`<1=xx>`声明调名，比如说`<1=B>`。
 - `<1=bD>`和`<1=Db>`的表述都是可以接受的。
 
  范例：南京地铁到站提示音：`<1=C>3125`。

### **音高操作符**

 - 音高操作符写在一个音符或和弦的右侧，用于改变其音高。
 - 音高操作符共有4个，分别为`#`，`b`，`,`以及`'`。
 - `#`将一个音升高半度，`b`将一个音降低半度。
 - `'`将一个音升高八度，`,`将一个音降低八度。
 - 音高操作符允许叠加和交换，但仅对其左侧的音生效。
 - 符号`'`、`,`可以写到调名中，表示所有音统一升高、降低八度。

  范例：一个A大调下的音阶用C大调表示为`<1=C>671#'2'3'4#'5#'6'`，它等价于`<1=C'>6,7,1#234#5#6`。
  
> QYM语法中，`#`和`b`是前置的，`,`和`'`是后置的；而在QYS语法下，这四个操作符都是后置的。
> 此外，QYM暂时不支持将`'`、`,`写到调名中的用法。

### **和弦记法**

 - 用方括号[]表示一个和弦，方括号里面依次写入每一个音。
 - 一个音右侧的音高操作符将只改变这个音的音高。
 - 方括号右侧的音高操作符将改变每一个音的音高。

  范例：一个和弦`[4#,6,1#]`，它等价于`[4#61'#],`。
  
> QYM中的和弦用&操作符来表示，如上面的例子在QYM中应写成`<1=bD>4,&6,&1`。

### **快速地表示前一个音**

QYS提供了符号%，用来快速地表示前一个音。具体用法如下：

 - `%`表示前一个音的音高，无论前一个音是单音还是和弦。
 - `%`只复制音高，不复制时值。
 - `%`不复制打击乐，休止符和倚音。
 - `%`后面可以继续使用音高操作符，改变`%`整体的音高

  范例：《Numb》的副歌部分第一句：`<1=F>[61'#6']%%[52'5'][61'6']%%%[747'][53'5']`（未标注时值）。
  
> QYM暂不支持这种用法。

### **时值操作符**

 - 时值操作符用于标记一个音的时值，位于音高操作符的右侧。
 - 时值操作符共有3个，分别是`-`，`_`，`.`。
 - `-`将时值增加一拍，`_`将时值减半。
 - 连续n个`.`的作用是将时值变为原来的(2-2^(-n))倍。
 - 时值操作符从左到右依次运算。
 - 当没有时值操作符时，默认为一拍。

  范例：`0-..`占3.5拍，而`1.-_`占1.25拍（虽然我们并不推荐这种写法）。

### **实例**

下面展示了《彩虹》的副歌部分。

    <1=C>
    0_5_4'_3'_|2'_1'_%_%_7_1'_2'_3'_|5-
    0_5_1'_7_|6_5_5_4_3_2_3_4_|5-
    0_5_5_5_|6.6_5#_6_7_3_|1'-
    0_1'_7_1'_|2'.%_%_1'_3'_4'_|2'-
    0_5_4#_5_|3'.%_4'_3'_2'_7_|1'-
    0_1'_7_1'_|5'.%_4'_3'_2'_3'_|3'-
    2'_5_4#_5_|3'.%_4'_3'_2'_7_|1'_2'_3'_7'_
    6'.3'_|5'_4'_3'_4'_3'2'|1'-

**[回到页首][14]**

----------

## **高级操作符**

在许多歌谱中使用了另外一些记号，而QYS也提供了对应的处理方案。
本章将依次介绍这些符号的用法。

> 注意：若无特殊声明，本章内的`X`，`Y`均指一个音，`ABC`指若干个音，`n`指一个整数，`r`指一个实数，`&`指一个单字符。

### **前言**

在这一章中，我们将学习许多不同的操作符，于是如何将它们有序地组合在一起就成了一件重要的事情。为了便于学习，QYS设计了一种非常简明的方案：

    (前置结构)[音高结构]后置结构

让我们简单地来看一下这三个结构。每个结构内部的元素都是并列的并且允许交换，而三个结构整体上必须按照上述的顺序排列。下面的说明能够让你快速地了解这三个结构分别是什么。

 - 前置结构一般用圆括号表示，如`(n-)`，`(n=)`和`(n~)`。
 - 音高结构是唱名，和弦，`%`以及音高操作符的整体。
 - 后置结构由单字符组成，包括时值操作符以及`` `。
 - 除此以外，还有跨音符操作符，包括`^`和`~`。

### **连音线**

 - 连音线用`^`表示。当`^`连接两个完全相同的音时，表示延长前一个音的时值。在这种情况下，我们推荐使用`^%`的组合，这能让阅读者一目了然。
 - 多个音之间的连音，应当在相邻每两个音之间都添加连音线。
 - 有关`^`的更多用法，参见[倚音][15]章节。

  范例：之前的实例`1.-_`中，更符合乐谱规范的表示方法是`1__^%`。

> QYM播放器中，每一个音默认只播放原时值的7/8，因此`^`被用于强调播放一个音为满时值。而QYS播放器中，每一个音默认按照满时值播放，所以只保留了延长前一个音的功能。事实上，`1^2`和`12`在QYS下的播放效果是完全相同的，但在QYM下前者听起来更加连贯。

### **n连音**

 - n连音用`(n~)ABC`表示，其功能为将之后的n个音符的时值变为原时值的(2^Floor[Log2[n]])/n倍。
 - 多连音的时值缩短效果对休止符也生效。
 - 应当注意到n连音与连音线混用时对时值产生的影响。比如`<4/4>(3~)XY^YZ-`共有4拍，而`<4/4>(3~)XY-Z-`只有10/3拍。

  范例：《东方之珠》主歌第一句：`5,_6,_11-(3~)3_2_1_5,--`。

> QYM中多连音的语法是`(n-)ABC`。

### **滑音**

 - 滑音用`X~Y`表示，其功能为将X到Y之间的所有音平均划分，将这些音以一拍的1/6位时值从X播放到Y，使得总时值为Y的时值。
 - 滑音的时值完全等于Y的时值，与X的时值无关。
 - 滑音的第一个音一定是X，但最后一个音有可能不是Y。但无论最后一个音是不是Y，下次调用操作符`%`都将返回Y的音高。

  范例：《九月のパンプキン》主旋律最后一节：`3'_4'_3'_1'#_[62']5~7,b`。

### **顿音**

 - 顿音用音符后的`` `表示，其功能为将时值缩短为其原时值的(1-r)倍，剩下的时值将自动用休止符补齐。
 - 上述参数r可以通过函数`<Stac:r>`声明，其中r是0到1之间的分数或小数，缺省值为1/2。
 - 顿音不能与连音线连用。

### **震音**

 - 单震音用`(n-)X`表示，其功能为以一拍的2^(-n)为时值播放X，持续X的时值。
 - 双震音用`X(n=)Y`表示，其功能为以一拍的2^(-n)为时值，交替播放X和Y，持续Y的时值。
 - 双震音的时值完全等于Y的时值，与X的时值无关。
 - 使用双震音时，应确保时值能够平分给X和Y，否则会出现由于多放了一个Y而导致的时值稍长的情况。

  范例1：《ラストリモート》片段：`7.1'#_(1-)2'-|(1-)1'#-(1-)2'-`

  范例2：《Gate of Steiner》片段：`3(4=)3'---`

> QYM中暂不支持单震音。

### **倚音**

 - 倚音用`(ABC^)X`表示，其功能为快速播放A,B,C,...后紧跟X。当ABC中不超过4个音时，每个音将播放1/16拍；否则这些音将平分1/4拍。这些音播放所占用的时值将从X的时值中扣除。
 - 和弦倚音用`[ABC^X]`表示，其功能为快速播放A,[AB],[ABC],...后紧跟[ABCX]。时值同上。
 - 倚音支持ABC中包含和弦的情况，但和弦倚音不支持ABC中包含和弦。
 - 和弦倚音右侧出现音高操作符时，将同和弦的用法一致，改变内部所有音的音高。

  范例1：《寂しい夜》主歌最后一小节：`3_4#_(7,34#^)5#-(4#5#7^)3'`。
  
  范例2：《宇宙を飛ぶ不思議な巫女》伴奏最后两小节：`[1#35#^1'#]--^|%--`

> QYM中暂不支持和弦倚音。

### **延长音**

> QYS中暂不支持延长音。如果您想要使用延长音，可以使用QYM语言。

### **实例**

下面展示了《ネクロファンタジア》的片段。

    <1=D><Dur:1>
    [41']-%%[61']-4'_5'_6'_1''_|[27]-%[572']7-5'_6'_7'
    1''_6'_3'_1'_7_1'_7_5_6_7,_3_7,_[24#6]-|1'74#'_5'_(3~)6'_4'_2'_7_4#_3_7,_6,_5,_4,
    [46]-%%4_6_1'_4'_6'_4'_1'_6_|[57]-%%7_2'_5'7_2'_5'
    [35#7]-5#'_2'_6'_2'_7'_2'_6'_2'_5#'_2'_0|[573']-.%-.%-^|%---4#,,,~1#---
    <1=C><Dur:0>
    [61'3'][131']'[137]'[72']_[573']_^|%-..[61'3']_^
    %[362']'[361']'[367]'_[361']'_^|%[37]'[136]'[135]'_[146]'_^
    %[15]'[13]'[135]'_[72'6']_^|%[72'5'][72'3'][72'5']_[573']_^
    %[572'][573'][575']_[573']_^|%_[73'](3=)5--[61'3']_^
    %[361']'[137]'[72']_[573']_^|%-..[61'3']_^
    %[362']'[361']'[367]'_[361']'_^|%[137]'[136]'[135]'_[146]'_^
    %[15]'[13]'[135]'_[72'6']_^|%[72'5'][72'3'][72'3'5']_[61#'3'6']_^
    %_3'-..(3=)1#'-..|3'-.(3=)1#'-.0

**[回到页首][16]**

----------

## **音轨与格式**

经过了上述两章的学习，我们已经能够完美地表现一首乐曲了。
接下来将介绍如何把这些记号写到.qys文件里。

### **小节号与换行符**

 - 与简谱类似，拍数用`<m/n>`声明。其中m表示一个小节的拍数，n表示以n分音符为一拍。
 - 与简谱类似，我们用`|`分隔两个相邻的小节。
 - 当已经完成了一个小节，且想要换行时，使用`\`换行。这里`\`充当了小节号，因此不必再次表明小节号了。
 - 请务必确保每个小节的拍数符合应有拍数，并确保没有在一个小节中间换行。否则播放器虽然能够正常播放，但会弹出相应的提示信息。如果相邻两个小节的拍数不同，应当在它们之间声明拍数。下面是一个例子（选自《βίος》的开头）：

        <Harp><1=bE><1.0><4/4>\
        0---|0---|<Dur:2>0-5,05,1017,07,5,0-5,2|0-5,05,1017,07,5,0-5,2\
        <Dur:1>652'5_1'2'5_2'5|652'5_1'2'5_2'5|652'5_1'2'5_2'5|652'5_1'2'5_2'2'_5'_\
        <2/4><Dur:0>0-|<4/4>\
        [61'3'6']%,[1361']'[2562']'|[61'3'6']%,[1361']'[2562']'\
        [361'3']'[6,136][51'3'5']'[61'3'6']'|[2572']'%,[1251']'[72'5'7']\

### **实音轨与空音轨**

 - 一个音轨由一次换行定义。以`\`结尾的换行不算做换行。空行不算做换行。因此下面的程序段（选自《運命のダークサイド》的开头）实际上只包含一个音轨：

        <Harp><1=bD><1.0><Dur:0>\
        3.3_4.4_|4#.%_5.5_|[33']_%_%_%_[44']_%%_|[44']#_%_%_%_[55']_%%_\
        
        <ElectricPiano><1=E><Dur:1>\
        [16]3_6_7_1'_[72'][46]--%|[57]6_7_7_1'_7_5_[7,3].[7,6b].[6b3']

 - 如果一个音轨内没有任何音符，则称之为一个空音轨；否则称之为一个实音轨。
 - 播放器会整合所有的实音轨并同时播放。
 - 关于空音轨的作用，请参见[变量与作用域][17]章节。

### 子音轨

> 此功能暂未开启。

### 反复与反复跳跃

> 此功能的语法正在更新。

### 添加注释

 - 我们推荐您在编写歌曲时留下您的注释，它能够让阅读者对于歌曲的信息一目了然。
 - 整行注释使用标记`//`，播放器将忽略其所在的整行。
 - 下面是一个使用注释的例子（选自《ネクロファンタジア》）：

        // Necro_Fantasia
        // 亡灵幻想曲 (ネクロファンタジア) 
        // composed by ZUN 
        // arranged by まらしぃ
        
        <4/4><170>
        
        //theme
        <Piano><1=E><0.8>\
        ......
        
        //accompaniment
        <Piano><1=E><0.6>\
        ......

**[回到页首][18]**

----------

## **变量与函数**

QYS允许编写者使用`<>`命令调整乐曲的基本参数。
之前看到的`<1=C>`，`<4/4>`以及`<Stac:1/2>`就是一些例子。
本章将介绍`<>`命令的使用方法。

### **基本变量声明**

QYS中目前有4个基本变量，分别为调名，节拍，速度和音量。这四个变量的声明方法与其他的变量不同，故需要单独说明。我们以《運命のダークサイド》的伴奏第一段为例：

    <ElectricPiano><168><1=bD,><4/4><0.4><Dur:0>\
    :[3,6,3].%_[4,6,4].%_|[4#,6,4#].%_[5,6,5].%_:\

 - 调名由`<1=bD>`声明，它也可以等价地替换为`<1=#C>`，甚至`<1=Db>`也是可以接受的。允许在其中加入音高操作符`'`和`,`以改变整段乐谱的音高。建议将音高操作符加在调名的后面。缺省值为`<1=C>`。
 - 节拍由`<4/4>`声明。这两个数字会被播放器用来计算时值以及检查你的歌谱，因此请务必将每个小节按规范书写。缺省值为`<4/4>`。
 - 速度由`<168>`声明，它表示一分钟播放90拍。这里的数字一定要是正整数，如果写小数则不会被识别。缺省值为`<90>`。
 - 音量由`<0.4>`声明，它表示以标准音量的0.4播放。这里的数字一定要是小数，如果没有小数点则不会被识别。缺省值为`<1.0>`。
 - 调名，节拍和速度只对声明后的乐谱生效，而音量对整个音轨生效。

### **乐器的声明**

QYS支持直接在`<>`中声明使用的乐器。乐器对声明后的乐谱生效，因此一个音轨内部运行切换乐器。乐器名区分大小写。缺省值为`<Piano>`。

 - 目前QYS支持的普通乐器如下：

> Accordion, Agogo, AltoSax, Applause, Atmosphere, Bagpipe, Bandoneon, Banjo, BaritoneSax, Bass, BassAndLead, Bassoon, Bird, BlownBottle, Bowed, BrassSection, Breath, Brightness, BrightPiano, Calliope, Celesta, Cello, Charang,Chiff, Choir, Clarinet, Clavi, Contrabass, Crystal, DrawbarOrgan, Dulcimer, Echoes, ElectricBass, ElectricGrandPiano, ElectricGuitar, ElectricPiano, ElectricPiano2, EnglishHorn, Fiddle, Fifths, Flute, FrenchHorn, FretlessBass, FretNoise, Glockenspiel, Goblins, Guitar, GuitarDistorted, GuitarHarmonics, GuitarMuted, GuitarOverdriven, Gunshot, Halo, Harmonica, Harp, Harpsichord, Helicopter, HonkyTonkPiano, JazzGuitar, Kalimba, Koto, Marimba, MelodicTom, Metallic, MusicBox, MutedTrumpet, NewAge, Oboe, Ocarina, OrchestraHit, Organ, PanFlute, PercussiveOrgan, Piano, Piccolo, PickedBass, PizzicatoStrings, Polysynth, Rain, Recorder, ReedOrgan, ReverseCymbal, RockOrgan, Sawtooth, SciFi, Seashore, Shakuhachi, Shamisen, Shanai, Sitar, SlapBass, SlapBass2, SopranoSax, Soundtrack, Square, Steeldrums, SteelGuitar, Strings, Strings2, Sweep, SynthBass, SynthBass2, SynthBrass, SynthBrass2, SynthDrum, SynthStrings ,SynthStrings2, SynthVoice, Taiko, Telephone, TenorSax, Timpani, Tinklebell, TremoloStrings, Trombone, Trumpet, Tuba, TubularBells, Vibraphone, Viola, Violin, Voice, VoiceAahs, VoiceOohs, Warm, Whistle, Woodblock, Xylophone

 - 目前QYS支持的打击乐如下：

> BassDrum, BassDrum2, BellTree, Cabasa, Castanets, ChineseCymbal, Clap, Claves, Cowbell, CrashCymbal, CrashCymbal2, ElectricSnare, GuiroLong, GuiroShort, HighAgogo, HighBongo, HighCongaMute, HighCongaOpen, HighFloorTom, HighTimbale, HighTom, HighWoodblock, HiHatClosed, HiHatOpen, HiHatPedal, JingleBell, LowAgogo, LowBongo, LowConga, LowFloorTom, LowTimbale, LowTom, LowWoodblock, Maracas, MetronomeBell, MetronomeClick, MidTom, MidTom2, MuteCuica, MuteSurdo, MuteTriangle, OpenCuica, OpenSurdo, OpenTriangle, RideBell, RideCymbal, RideCymbal2, ScratchPull, ScratchPush, Shaker, SideStick, Slap, Snare, SplashCymbal, SquareClick, Sticks, Tambourine, Vibraslap, WhistleLong, WhistleShort

### **作用域与缺省值**

 - QYS中的所有变量都有缺省值。未声明之前的变量默认取缺省值。
 - 变量的作用域分为两种。第一种变量对所在音轨内声明处以后的乐谱生效；第二种变量对整个所在音轨生效。目前绝大部分变量属于第一类，因此我们只列出属于第二类的变量：

 > volume(音量), fade(渐强/渐弱)

 - 当音轨存在从属关系时，高级音轨中的变量的值将作为低级音轨中变量的缺省值。特别的，空音轨中声明的变量的值将成为所有音轨中变量的缺省值。

### **时值缩放函数**

### **渐弱与渐强函数**

### **其他函数**

下面的列表展示了QYS中其他函数的功能和缺省值。

<table>
    <tr>
        <th>函数名</th>
        <th>函数功能</th>
        <th>缺省值</th>
    </tr>
    <tr>
        <td><code>Stac:r</code></td>
        <td>调整顿音参数r</td>
        <td>1/2</td>
    </tr>
</table>

**[回到页首][20]**


  [1]: #%E9%9F%B3%E7%AC%A6%E4%B8%8E%E5%92%8C%E5%BC%A6
  [2]: #%E9%AB%98%E7%BA%A7%E6%93%8D%E4%BD%9C%E7%AC%A6
  [3]: #%E9%9F%B3%E8%BD%A8%E4%B8%8E%E6%A0%BC%E5%BC%8F
  [4]: #%E5%8F%98%E9%87%8F%E4%B8%8E%E5%87%BD%E6%95%B0
  [5]: #%E5%94%B1%E5%90%8D%E4%B8%8E%E8%B0%83%E5%90%8D
  [6]: #%E9%9F%B3%E9%AB%98%E6%93%8D%E4%BD%9C%E7%AC%A6
  [7]: #%E5%92%8C%E5%BC%A6%E8%AE%B0%E6%B3%95
  [8]: #%E6%97%B6%E5%80%BC%E6%93%8D%E4%BD%9C%E7%AC%A6
  [9]: #%E8%BF%9E%E9%9F%B3%E7%BA%BF
  [10]: #%E5%B0%8F%E8%8A%82%E5%8F%B7%E4%B8%8E%E6%8D%A2%E8%A1%8C%E7%AC%A6
  [11]: #%E6%B7%BB%E5%8A%A0%E6%B3%A8%E9%87%8A
  [12]: #%E5%9F%BA%E6%9C%AC%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E
  [13]: #%E4%B9%90%E5%99%A8%E7%9A%84%E5%A3%B0%E6%98%8E
  [14]: #%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B
  [15]: #%E5%80%9A%E9%9F%B3
  [16]: #%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B
  [17]: #%E5%8F%98%E9%87%8F%E4%B8%8E%E4%BD%9C%E7%94%A8%E5%9F%9F
  [18]: #%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B
  [19]: #%E9%A1%BF%E9%9F%B3
  [20]: #%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B